---
import PageLayout from "@layouts/PageLayout.astro";
import { FetchReadableStreamTransport } from "@utils/grpc/transport";
import { Book, GetBookByIdRequest } from "grpc-ts/eshop_pb";
import { ServiceError, EshopServiceClient } from "grpc-ts/eshop_pb_service";

const transport = FetchReadableStreamTransport({});

const client = new EshopServiceClient("http://0.0.0.0:9000", { transport });
const req = new GetBookByIdRequest();

req.setId("cock");

const res = new Promise<Book | null>((resolve, reject) => {
  client.getBookById(req, (err, res) => {
    if (err) {
      reject(err);
    } else {
      resolve(res);
    }
  });
});

const isServiceError = (e: unknown): e is ServiceError => {
  return e instanceof Error && "code" in e && "message" in e && "metadata" in e;
};

let text;

try {
  const response = await res;
  text = response?.getName();
} catch (e) {
  if (isServiceError(e)) {
    text = e.message;
  }
}
---

<PageLayout>
  <h1>omegalul</h1>
  <p>{text}</p>
</PageLayout>
