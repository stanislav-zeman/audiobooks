---
import BookCard from "@components/search/BookCard.astro";
import Category from "@components/search/Category.astro";
import Price from "@components/search/Price.astro";
import Layout from "@layouts/SearchLayout.astro";
import Search from "@components/icons/Search.astro";
import { EshopServiceClient } from "grpc-ts/eshop_pb_service";
import { Tags, Void } from "grpc-ts/eshop_pb";
import { FetchReadableStreamTransport } from "@utils/grpc/transport";

const params = Astro.url.searchParams;

console.error(params);

const prices = [
  {
    name: "Free",
    slug: "free",
  },
  {
    name: "Premium",
    slug: "premium",
  },
];

const books = [
  {
    id: "1",
    title: "The Adventures of Tom Sawyer",
    price: "Free",
    image: "https://placekitten.com/500/500",
    rating: 4,
  },
  {
    id: "2",
    title: "All Quiet on the Western Front",
    price: "Free",
    image: "https://placekitten.com/600/600",
    rating: 3.1,
  },
  {
    id: "3",
    title: "The Great Gatsby",
    price: "$ 4.99",
    image: "https://placekitten.com/400/400",
    rating: 4.5,
  },
  {
    id: "4",
    title: "Algorithms and Data Structures II",
    price: "$ 69.99",
    image: "https://placekitten.com/600/600",
    rating: 1.2,
  },
];

const transport = FetchReadableStreamTransport({});
const client = new EshopServiceClient("http://0.0.0.0:9000", { transport });

const req = new Void();

const promise = new Promise<Tags | null>((resolve, reject) => {
  client.getTags(req, (err, res) => {
    if (err) return reject(err);
    resolve(res);
  });
});

const tags = await promise;

console.log(tags?.getTagsList());

const categories = tags?.getTagsList().map((tag) => {
  return {
    name: tag,
    slug: tag,
  };
});
---

<Layout>
  <div class="p-6 flex w-full gap-5 flex-wrap md:flex-nowrap">
    <div class="flex-auto w-1/3">
      <form>
        <label for="search" class="sr-only">Search</label>
        <div class="relative">
          <div
            class="absolute inset-y-0 left-0 flex items-center pl-3 pointer-events-none"
          >
            <Search class="w-5 h-5 text-gray-500 dark:text-gray-400" />
          </div>
          <input
            type="search"
            id="search"
            name="search"
            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full pl-10 p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
            placeholder="Search"
          />
        </div>
        <span class="sr-only">Search</span>

        <h3 class="mt-4 mb-4 font-semibold text-gray-900 dark:text-white">
          Categories
        </h3>
        <ul
          class="text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          {categories.map((category) => <Category {...category} />)}
        </ul>

        <h3 class="mt-4 mb-4 font-semibold text-gray-900 dark:text-white">
          Price
        </h3>
        <ul
          class="text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          {prices.map((price) => <Price radioName="price" {...price} />)}
        </ul>
        <div class="w-full mt-4">
          <button
            type="submit"
            class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800 w-full"
          >
            Filter
          </button>
          <button
            type="reset"
            class="text-white focus:outline-none font-medium rounded-lg text-sm px-5 py-2.5 text-center w-full"
          >
            Reset
          </button>
        </div>
      </form>
    </div>
    <div class="flex flex-auto w-full flex-wrap gap-5">
      {books.map((book) => <BookCard {...book} />)}
    </div>
  </div>
</Layout>
